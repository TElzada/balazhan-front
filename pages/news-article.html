<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Новость</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../styles/style.css">
</head>
<body>
<main class="container my-4">
  <a class="btn btn-link mb-3" href="news.html">← Все новости</a>
  <article id="newsArticle"></article>
</main>

<script>
  (async function () {
    const API_BASE = 'http://localhost:8080';
    const DATA_URL = 'data/news.json';

    const params = new URLSearchParams(location.search);
    const slug = params.get('slug');
    const container = document.getElementById('newsArticle');

    if (!slug) {
      container.innerHTML = '<p class="text-danger">Не указан slug новости.</p>';
      return;
    }

    try {
      // 1) сначала пробуем найти новость в списке, который отдаёт бэк
      let it = await loadFromBackendList(slug);

      // 2) если не нашли или бэк не отвечает — пробуем старый JSON
      if (!it) {
        it = await loadFromJson(slug);
      }

      if (!it) {
        container.innerHTML = '<p class="text-muted">Новость не найдена.</p>';
        return;
      }

      renderArticle(it);
    } catch (e) {
      console.error(e);
      container.innerHTML = '<p class="text-danger">Ошибка загрузки новости.</p>';
    }

    async function loadFromBackendList(slug) {
      try {
        const res = await fetch(`${API_BASE}/api/news`);
        if (!res.ok) {
          throw new Error('Ошибка при загрузке новостей с бэка: ' + res.status);
        }
        const list = await res.json();
        if (!Array.isArray(list)) return null;
        return list.find(x => x.slug === slug) || null;
      } catch (e) {
        console.error('Ошибка при загрузке из /api/news', e);
        return null;
      }
    }

    async function loadFromJson(slug) {
      try {
        const res = await fetch(DATA_URL);
        if (!res.ok) throw new Error('Не удалось загрузить ' + DATA_URL);
        const list = await res.json();
        if (!Array.isArray(list)) return null;
        return list.find(x => x.slug === slug) || null;
      } catch (e) {
        console.error('Ошибка при загрузке из JSON', e);
        return null;
      }
    }

    function renderArticle(it) {
      const imgHtml = it.imageUrl
              ? `<img src="${escapeHtml(it.imageUrl)}" alt="${escapeHtml(it.title || '')}" class="img-fluid mb-3 rounded">`
              : '';

      const dateText = it.date || it.publishedAt || it.published_at || '';

      container.innerHTML = `
        <div class="card p-3">
          ${imgHtml}
          <h1>${escapeHtml(it.title || '')}</h1>
          <div class="text-muted small mb-2">${escapeHtml(dateText)}</div>
          <div class="mb-3">${it.content || ''}</div>
        </div>
      `;
    }

    function escapeHtml(s) {
      if (!s) return '';
      return String(s)
              .replaceAll('&', '&amp;')
              .replaceAll('<', '&lt;')
              .replaceAll('>', '&gt;')
              .replaceAll('"', '&quot;')
              .replaceAll("'", '&#039;');
    }
  })();
</script>
</body>
</html>
